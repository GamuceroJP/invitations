<!DOCTYPE html>
<html>
<head>
  <title>Formulario RSVP XV - Ana Pau</title>
  <style>
    body {
      font-family: 'Georgia', serif;
      background-color: #85A59D;
      color: white;
      max-width: 600px;
      margin: auto;
      padding: 30px;
      text-align: center;
    }

    h2 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.15);
      padding: 25px;
      border-radius: 20px;
      margin-top: 20px;
      backdrop-filter: blur(4px);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }

    .btn {
      background: linear-gradient(180deg, #F4E3AB 0%, #C6A76F 100%);
      color: #333;
      padding: 14px;
      border: none;
      border-radius: 30px;
      font-size: 18px;
      width: 100%;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn:hover {
      opacity: 0.9;
    }

    #step2 { display: none; }
    #success { display: none; font-weight: bold; font-size: 22px; margin-top: 20px; }
  </style>
</head>
<body>

<h2>Confirmación de Asistencia</h2>

<div class="card" id="step1">
  <p>Ingresa tu código de invitación:</p>
  <input id="code" type="text" placeholder="Código">
  <button class="btn" onclick="validateCode()">Validar Código</button>
  <p id="error" style="color:#ffdddd"></p>
</div>

<div class="card" id="step2">
  <h3 id="welcome"></h3>
  <p id="capacityText"></p>

  <div id="asistentesContainer"></div>

  <label>¿Asistirás a la ceremonia?</label>
  <select id="ceremonia">
    <option value="Sí">Sí</option>
    <option value="No">No</option>
  </select>

  <label>¿Algún invitado tiene restricciones alimenticias?</label>
  <textarea id="restricciones" placeholder="Especifica aquí"></textarea>

  <label>Correo electrónico de contacto</label>
  <input id="correo" type="email" placeholder="tu@correo.com">

  <button class="btn" onclick="submitRSVP()">Enviar RSVP</button>
</div>

<p id="success">¡Gracias! Tu respuesta ha sido registrada.</p>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxNBPt9HgMf9wgG6VIjvltKiGtpiK5P6ELBUFwyNdHoeQtqhhmdBk2sdDR9bmap2PI1OA/exec";  // <-- reemplaza esto
const SECRET = "key_AnaPau";

let globalCode = "";
let globalCapacity = 0;
let globalNombre = "";

/******** VALIDAR CÓDIGO *********/
function validateCode() {
  const code = document.getElementById('code').value.trim();
  globalCode = code;

  fetch(API_URL + `?action=validateCode&secret=${SECRET}&code=${code}`)
    .then(res => res.json())
    .then(data => {
      if (!data.found) {
        document.getElementById('error').innerText = "Código inválido";
        return;
      }

      globalCapacity = data.capacity;
      globalNombre = data.nombre;

      document.getElementById('error').innerText = "";
      document.getElementById('step2').style.display = "block";
      document.getElementById('welcome').innerText =
        `Gracias por acompañarnos, ${globalNombre}`;
      document.getElementById('capacityText').innerText =
        `Con cariño hemos apartado ${globalCapacity} lugares para ustedes`;

      // GENERAR CAMPOS DE NOMBRES
      const container = document.getElementById("asistentesContainer");
      container.innerHTML = "<h4>Nombre de los asistentes:</h4>";

      for (let i = 1; i <= globalCapacity; i++) {
        container.innerHTML += `
          <input type="text" id="asistente${i}" placeholder="Nombre ${i}">
        `;
      }
    });
}

/******** ENVIAR RSVP *********/
function submitRSVP() {
  const asistentes = [];
  for (let i = 1; i <= globalCapacity; i++) {
    const val = document.getElementById(`asistente${i}`).value.trim();
    if (val) asistentes.push(val);
  }

  const ceremonia = document.getElementById('ceremonia').value;
  const restricciones = document.getElementById('restricciones').value;
  const correo = document.getElementById('correo').value;

  fetch(API_URL + `?action=submitRSVP&secret=${SECRET}` +
    `&code=${globalCode}` +
    `&ceremonia=${encodeURIComponent(ceremonia)}` +
    `&restricciones=${encodeURIComponent(restricciones)}` +
    `&correo=${encodeURIComponent(correo)}` +
    `&asistentes=${encodeURIComponent(JSON.stringify(asistentes))}`
  )
  .then(res => res.json())
  .then(data => {
    document.getElementById("success").style.display = "block";
  });
}
</script>

</body>
</html>
